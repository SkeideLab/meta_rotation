---
title: "A meta-analysis of mental rotation ability in the first years of life"
author: "Alexander Enge, Shreya Kapoor, Anne-Sophie Kieslinger & Michael A. Skeide"
date: "`r paste('Commit', substr(git2r::commits()[[1]]$sha, 1, 7))`"
output:
  pdf_document:
    latex_engine: xelatex
---

```{r, setup, include=FALSE}
# Load packages
library(here)
library(ggridges)
library(tidyverse)
library(magrittr)
library(metafor)
library(brms)

# Global chunk options
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  fig.height = 10,
  fig.width = 7.5,
  out.width = "100%"
)
```

```{r, get_data}
# Directory paths
data_dir <- here("data")

# Download literature search spreadsheet from Google Drive
excel_url <- "https://docs.google.com/spreadsheets/d/1xnC0NlQYTXavXaeqQidhi7UKb1pCGAl9Ry3h3Uz3mi0"
excel_file <- here(data_dir, "literature_search.xlsx")
# googledrive::drive_auth(use_oob = TRUE)
# googledrive::drive_download(excel_url, excel_file, overwrite = TRUE)

# Read sheets
screening <- readxl::read_excel(excel_file, sheet = "screening")
included <- readxl::read_excel(excel_file, sheet = "included", na = "NA")
```

# Results

Effect sizes of individual experiments:

```{r, compute_effects, echo=TRUE}
# Add columns to the table of included experiments
included %>%
  mutate(
    # Add difference between condition means
    mean_diff = case_when(
      !is.na(mean_diff) ~ mean_diff,
      TRUE ~ mean_novel - mean_familiar
    ),
    # Add d_z from paired t test of condition means (Rosenthal, 1991)
    d_z_t = t / sqrt(sample_size),
    # Add d_z from mean and standard deviation of the difference
    d_z_diff = mean_diff / sd_diff,
    # Add d_av from mean difference and standard devations (assumes r = 0)
    # (Cumming, 2012)
    sd_av = (sd_novel + sd_familiar) / 2,
    d_av = mean_diff / sd_av,
    # Add d from one-sample t test of novelty preference scores
    d_nov_pref = (nov_pref - 0.5) / sd_nov_pref,
    # Choose one type of outcome variable for each experiment
    yi = case_when(
      # 1. If d was reported directed
      !is.na(d) ~ d,
      # 2. If a paired sample t test was reported
      !is.na(d_z_t) ~ d_z_t,
      # 3. If the difference between means and its SD were reported
      !is.na(d_z_diff) ~ d_z_diff,
      # 4. If the individual condition means and their SDs were reported
      !is.na(d_av) ~ d_av,
      # 5. If a novelty preference score and its SD were reported
      !is.na(d_nov_pref) ~ d_nov_pref
    ),
    # Keep track which type of outcome measure was chosen for each article
    yi_type = case_when(
      !is.na(d) ~ "d",
      !is.na(d_z_t) ~ "d_z_t",
      !is.na(d_z_diff) ~ "d_z_diff",
      !is.na(d_av) ~ "d_av",
      !is.na(d_nov_pref) ~ "d_nov_pref",
      TRUE ~ "none"
    ) %>%
      factor(levels = c(
        "d", "d_z_t", "d_z_diff", "d_av", "d_nov_pref", "none"
      )),
    # Find studies with any value of d_z (from t test or mean / SD of the diff.)
    d_z = case_when(
      !is.na(d_z_t) ~ d_z_t,
      !is.na(d_z_diff) ~ d_z_diff
    ),
    # Compute SD of the difference based on d_z
    sd_z = mean_diff / d_z,
    # Compute correlation based on sd_z and condition SDs
    ri = (sd_z^2 - sd_novel^2 - sd_familiar^2) / (-2 * sd_novel * sd_familiar)
  ) %>%
  # Exclude experiments with redundant samples, missing stats, or age > 2 years
  filter(!redundant & !is.na(yi) & age_mean < 730) -> dat

# Overview of the different effect sizes
dat %>%
  select(id, group, yi_type, yi, d, d_z_t, d_z_diff, d_av, d_nov_pref, ri) %>%
  print(n = Inf)

# Correlations between dependent samples
summary(dat$ri)
```

Actual meta-analysis:

```{r, compute_meta, echo=TRUE}
# Compute standard error of Cohen's d based on assumed correlation
# This will need a sensitivity analysis
r_assumed <- 0.5
dat %>%
  mutate(
    ni = sample_size,
    sei = sqrt(((2 * (1 - r_assumed)) / ni) + (yi^2 / (2 * ni))),
    age_months = age_mean / 30.417
  ) %>%
  select(id, group, age_months, female_percent, ni, yi, sei) %>%
  # Compute sampling variance from standard errors
  escalc(yi = yi, sei = sei, ni = ni, data = .) %>%
  tibble() -> dat_r

# Create vector of experiment IDs for plotting
experiment_ids <- with(dat_r, paste(id, group, sep = ", "))

# # Two-level model
# res <- rma(
#   yi, vi,
#   data = dat_r,
#   slab = experiment_ids
# )
# print(res)
# forest(res)

# Three-level model
res_mv <- rma.mv(
  yi, vi,
  random = ~ group | id,
  data = dat_r,
  slab = experiment_ids
)
print(res_mv)
forest(res_mv)

# # Saving the forest plot
# pdf("forest.pdf", width = 12, height = 12)
# forest(res_mv)
# dev.off()

# # Profile likelihodd plots
# profile(res_mv, sigma2 = 1)
# profile(res_mv, sigma2 = 2)

# Meta-regression with age
res_age <- rma.mv(
  yi, vi,
  mods = ~age_months,
  random = ~ group | id,
  data = dat_r,
  slab = experiment_ids
)
print(res_age)
forest(res_age)

# Meta-regression with gender
res_gender <- rma.mv(
  yi, vi,
  mods = ~female_percent,
  random = ~ group | id,
  data = dat_r,
  slab = experiment_ids
)
print(res_gender)
forest(res_gender)

# Meta-regression with age, gender, and their interaction
res_full <- rma.mv(
  yi, vi,
  mods = ~ age_months * female_percent,
  random = ~ group | id,
  data = dat_r,
  slab = experiment_ids
)
print(res_full)
forest(res_full)
```

```{r, brms, echo=TRUE}
# Specify priors
priors <- c(
  prior(normal(0, 1), class = "Intercept"),
  prior(exponential(1), class = "sd")
)

# Run Bayesian multilevel model
res_brm <- brm(
  yi | se(sei) ~ 1 + (1 | group / id),
  data = dat_r,
  prior = priors,
  cores = 4,
  chains = 4,
  iter = 2000,
  sample_prior = TRUE,
  save_pars = save_pars(all = TRUE)
)
summary(res_brm)

# Sensitivity analysis
list(
  "ic_uninformative" = c(
    prior(uniform(-3, 3), class = "Intercept"),
    prior(exponential(1), class = "sd")
  ),
  "ic_informative" = c(
    prior(normal(0, 0.2), class = "Intercept"),
    prior(exponential(1), class = "sd")
  ),
  "sigma_uninformative" = c(
    prior(normal(0, 1), class = "Intercept"),
    prior(uniform(0, 5), class = "sd")
  ),
  "sigma_informative" = c(
    prior(normal(0, 1), class = "Intercept"),
    prior(exponential(0.1), class = "sd")
  )
) %>%
  map(function(priors) update(res_brm, prior = priors)) -> res_sens
```

# Methods

## Information sources and search strategy

Article sources:

```{r}
table(screening$source)
```

## Selection process

### Interrater agreement

Percent agreement for binary decision (include/exclude):

```{r}
with(screening, mean(bin_1 == bin_2))
```

Cohen's kappa for binary decision (include/exclude):

```{r}
with(screening, psych::cohen.kappa(cbind(bin_1, bin_2)))
```

Correlation (phi) for binary decision (include/exclude):

```{r}
with(screening, cor.test(bin_1, bin_2))
```

Percent agreement for exclusion codes:

```{r}
with(screening, mean(code_1 == code_2))
```

Cohen's kappa for exclusion codes:

```{r}
with(screening, psych::cohen.kappa(cbind(code_1, code_2)))
```

### Final decisions

Exlucsion codes:

```{r}
cat("1 = not in english
2 = not a group study
3 = not infants
4 = not typically developing
5 = no mental rotation
6 = no within-group statistics
7 = include paper
8 = no access or insufficient statistics")
table(screening$code_final)
```

### Included experiments

Total number of articles (according to `screening` table):

```{r}
sum(screening$code_final == 7)
```

Total number of articles (according to `included` table):

```{r}
length(unique(included$id))
```

Total number of experiments:

```{r}
nrow(included)
```

Number of non-redundant experiments:

```{r}
nrow(filter(included, !redundant))
```

Number of experiments per type of effect size:

```{r}
table(included$yi_type)
```

Total number of infants across experiments:

```{r}
sum(included$sample_size)
```

Descriptive information about the infant samples:

```{r}
included %>%
  select(sample_size, age_mean, age_sd, age_min, age_max, female_percent) %>%
  summary()
```

Age and gender distributions of all experiments:

```{r}
included %>%
  uncount(1e4) %>%
  mutate(
    group_text = if_else(is.na(group), "NA", group),
    id_group = str_c(id, ", ", group_text),
    id_group_ordered = fct_reorder(id_group, age_mean, .desc = TRUE),
    age_sd = if_else(!is.na(age_sd), age_sd, 10.),
    days = rnorm(n(), age_mean, age_sd),
    months = days / 30.417,
  ) %>%
  ggplot(aes(x = months, y = id_group_ordered, fill = female_percent)) +
  geom_density_ridges() +
  scale_fill_distiller(palette = "RdYlBu") +
  coord_cartesian(xlim = c(1, 20), expand = FALSE) +
  labs(x = "Age (m)", fill = "Percent\nfemale") +
  theme_minimal() +
  theme(
    axis.title.y = element_blank(),
    legend.position = "bottom",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    text = element_text(family = "Helvetica", size = 10)
  )
```

Sample sizes and ages of all experiments:

```{r}
included %>%
  mutate(months = age_mean / 30.417) %>%
  ggplot(aes(
    x = months,
    y = sample_size,
    size = sample_size,
    color = female_percent
  )) +
  geom_point() +
  scale_color_viridis_c() +
  scale_size(guide = "none") +
  coord_cartesian(xlim = c(0, 16)) +
  labs(x = "Age (m)", y = "Sample size", color = "Percent\nfemale") +
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    text = element_text(family = "Helvetica", size = 10)
  )
```
