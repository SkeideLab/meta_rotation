<!-- Re-define labels for tables and figures -->
\captionsetup[table]{name=Supplementary Table}
\captionsetup[figure]{name=Supplementary Fig.}

<!-- Restart numbering of figures, tables, equations, and pages -->
\renewcommand{\thefigure}{\arabic{figure}}
\renewcommand{\thetable}{\arabic{table}}
\renewcommand{\theequation}{\arabic{table}}
\setcounter{figure}{0}
\setcounter{table}{0}
\setcounter{equation}{0}
\setcounter{page}{1}

# Supplementary information

```{r, tabs1, include=TRUE}
# Save within-analysis table of experiments
dat %>%
  mutate(
    age_mean = format_days_months(age_mean),
    age_sd = str_c(as.character(round(age_sd)), "d"),
  ) %>%
  transmute(
    Article = if_else(article == lag(article, default = ""), "", article),
    Experiment = group_long,
    `Sample size` = sample_size,
    `Females` = round(female_percent * sample_size),
    Age = str_c(age_mean, "±", age_sd, sep = " "),
    Task = task,
    `Stimulus type` = str_to_sentence(stimuli_presentation),
    `Stimulus dimensions` = stimuli_dimensions
  ) -> tabs1

# Display the table
apa_table(
  tabs1,
  caption = "Experiments included in the main analysis",
  landscape = TRUE, font_size = "scriptsize"
)

# Save the table
dir.create(tables_dir, showWarnings = FALSE)
write_csv(tabs1, file = here(tables_dir, "tabs1_experiments.csv"), na = "n/a")
```

\renewcommand{\arraystretch}{1.5}

```{r, frequentist}
# Three-level model
res_freq <- rma.mv(
  gi, vi,
  random = ~ 1 | article / experiment,
  data = dat,
  slab = experiment
)
print(res_freq)

# Check share of variance at each level of the model
round(res_freq$sigma2[1] / sum(res_freq$sigma2), 3) # Between-art. (ICC)
round(res_freq$sigma2[2] / sum(res_freq$sigma2), 3) # Within-art. (between-exp.)

# Get profile likelihoods for sigmas to check that REML has converged
prof_liks <- profile(res_freq, plot = FALSE)

# Meta-regression with gender, age, and task
res_reg_freq <- rma.mv(
  gi, vi,
  mods = ~ gender * age_c + task,
  random = ~ 1 | article / experiment,
  data = dat,
  slab = experiment
)
print(res_reg_freq)

# Meta-analysis of gender differences
res_gender_freq <- rma.mv(
  gi, vi,
  random = ~ 1 | article / experiment,
  data = dat_gender,
  slab = experiment
)
print(res_gender_freq)
```

```{r, tabs2, include=TRUE}
# Format all frequentist results together as a table
map2_dfr(
  c("Meta-analysis", "Meta-regression", "Gender differences"),
  list(res_freq, res_reg_freq, res_gender_freq),
  function(name, res) {
    # Intercept / regression weights
    tibble(
      Model = c(name, rep(NA, length(res$b) - 1)),
      Parameter = rownames(res$b),
      Estimate = print_num(as.numeric(res$b)),
      `$SE$` = print_num(res$se),
      `$z$` = print_num(res$zval),
      `$p$` = print_num(res$pval, digits = 3),
      ci_lower = print_num(res$ci.lb),
      ci_upper = print_num(res$ci.ub)
    ) %>%
      # Re-format confidence interval
      mutate(
        `95\\% CI` = str_c("[", ci_lower, ", ", ci_upper, "]"),
        .keep = "unused"
      ) %>%
      # Add variances
      bind_rows(tibble(
        Parameter = res$s.name,
        Estimate = print_num(res$sigma2)
      ))
  }
) %>%
  # Rename parameters for readibility
  mutate(
    Parameter = c(
      "Hedges' $g$",
      "$\\sigma_{\\text{Article}}^2$",
      "$\\sigma_{\\text{Experiment}}^2$",
      "Intercept",
      "Female - mixed",
      "Male - female",
      "Age (per year)",
      "Habituation - VoE",
      "(Female - mixed) × age",
      "(Male - female) × age",
      "$\\sigma_{\\text{Article}}^2$",
      "$\\sigma_{\\text{Experiment}}^2$",
      "Hedges' $g$",
      "$\\sigma_{\\text{Article}}^2$",
      "$\\sigma_{\\text{Experiment}}^2$"
    )
  ) %>%
  # Replace NAs with blank cells
  mutate(across(.fns = ~ ifelse(is.na(.), "", .))) -> tab_freq

# Display the table
apa_table(
  tab_freq,
  align = "llccccc",
  caption = "Frequentist meta-analyses and meta-regression",
  font_size = "scriptsize",
  escape = FALSE
)

# Save the table
write_csv(tab_freq, file = here(tables_dir, "tabs2_frequentist.csv"))
```

```{r, sensitivity_analysis, eval=FALSE, include=TRUE}
# Compute empirical estimate of the correlation between dependent samples
dat %>%
  mutate(
    # Get effect size from paired samples t-test, one sample t-test, or ANOVA
    d_diff = case_when(
      !is.na(d) ~ d,
      !is.na(d_z_t) ~ d_z_t,
      !is.na(d_z_f) ~ d_z_f,
      !is.na(d_z_diff) ~ d_z_diff
    ),
    # Compute empirical correlation
    # Basesd on the SD of the difference and the SDs within the two conditions
    sd_diff = mean_diff / d_diff,
    ri = (sd_diff^2 - sd_novel^2 - sd_familiar^2) /
      (-2 * sd_novel * sd_familiar)
  ) %>%
  pull(ri) -> ri_empirical

# Summarise the estimated correlations
summary(ri_empirical)

# Re-run the meta-analysis for different values of r_assumed
seq(-0.9, 0.9, by = 0.3) %>%
  set_names(., str_c("r = ", print_num(.))) %>%
  map(function(ri_sens) {

    # Re-compute standard errors of the effect sizes
    mutate(
      dat,
      vi = (dfi / (dfi - 2)) * ((2 * (1 - ri_sens)) / ni) *
        (1 + gi^2 * (ni / (2 * (1 - ri_sens)))) - (gi^2 / ji^2),
      sei = sqrt(vi)
    ) -> dat_ri_sens

    # Re-run meta-analysis
    update(res_brm, newdata = dat_ri_sens, refresh = 0)
  }) -> res_ri_sens

# Prior sensitivity analysis
list(
  "Intercept U(-10,10)" = c(
    set_prior("uniform(-10, 10)", class = "Intercept"),
    set_prior("cauchy(0, 0.3)", class = "sd")
  ),
  "Intercept N(0,0.2)" = c(
    set_prior("normal(0, 0.2)", class = "Intercept"),
    set_prior("cauchy(0, 0.3)", class = "sd")
  ),
  "SD U(0,10)" = c(
    set_prior("normal(0, 1)", class = "Intercept"),
    set_prior("uniform(0, 10)", class = "sd")
  ),
  "SD Student-t(10,0,0.2)" = c(
    set_prior("normal(0, 1)", class = "Intercept"),
    set_prior("student_t(10, 0, 0.2)", class = "sd")
  )
) %>%
  # Re-run the meta-analysis with different priors
  map(
    function(prior_sens) update(res_brm, prior = prior_sens, refresh = 0)
  ) -> res_prior_sens

# Create a table summarizing all sensitivity analyses
map2_dfr(
  c(res_ri_sens, res_prior_sens),
  c(names(res_ri_sens), names(res_prior_sens)),
  function(res, name) {

    # Compute ICC
    var_experiment <- as.matrix(
      res,
      variable = "sd_article:experiment__Intercept"
    )^2
    var_article <- as.matrix(
      res,
      variable = "sd_article__Intercept"
    )^2
    var_total <- var_experiment + var_article
    icc <- var_article / var_total
    icc_row <- mean_qi(icc) %>%
      rename(Estimate = y, `l-95% CI` = ymin, `u-95% CI` = ymax)

    # Create a data frame row of summary statistics
    with(summary(res), bind_rows(fixed, bind_rows(random))) %>%
      bind_rows(icc_row) %>%
      transmute(
        parameter = c("Hedges' g", "SD_{article}", "SD_{experiment}", "ICC"),
        Estimate = print_ci(Estimate, `l-95% CI`, `u-95% CI`)
      ) %>%
      pivot_wider(names_from = parameter, values_from = Estimate) %>%
      bind_cols(Simulation = name, .)
  }
) -> tab_sens

# Display the table
apa_table(
  tab_freq,
  caption = "Sensitivity analyses",
  font_size = "scriptsize"
)

# Save the table
write_csv(tab_sens, file = here(tables_dir, "sensitivity.csv"))
```

<!-- Supplementary figures -->

```{r, figs1, include=TRUE, fig.height=10, fig.width=12, fig.cap="(ref:figs1-caption)"}
# Get posterior draws for the effect in each experiment
epred_draws_brm_gender <- epred_draws(res_brm_gender, dat_gender, ndraws = NULL) %>%
  mutate(experiment_f = factor(experiment))

# Create forest plot
dat_gender %>%
  # Make sure the plot will be ordered alphabetically by experiment IDs
  arrange(experiment) %>%
  mutate(
    experiment_f = fct_rev(fct_expand(factor(experiment), "model")),
    # Show article labels only for the first experiment per article
    article = if_else(article == lag(article, default = ""), "", article),
    # Compute frequentist confidence intervals
    ci_lb = gi - qnorm(0.05 / 2, lower.tail = FALSE) * sqrt(vi),
    ci_ub = gi + qnorm(0.05 / 2, lower.tail = FALSE) * sqrt(vi),
    ci_print = print_ci(gi, ci_lb, ci_ub)
  ) %>%
  # Prepare plotting canvas
  ggplot(aes(x = gi, y = experiment_f)) +
  geom_vline(xintercept = seq(-3, 3, 0.5), color = "grey90") +
  # Add article and group labels as text on the left
  geom_text(aes(x = -9.9, label = article), hjust = 0) +
  geom_text(aes(x = -7.1, label = group_long), hjust = 0) +
  # Add experiment-specific effect sizes and CIs as text on the right
  geom_text(aes(x = 3.7, label = print_num(gi)), hjust = 1) +
  geom_text(aes(x = 4.4, label = print_num(ci_lb)), hjust = 1) +
  geom_text(aes(x = 5.1, label = print_num(ci_ub)), hjust = 1) +
  # Add Bayesian highest posterior density intervals for each experiment
  stat_interval(
    aes(x = .epred),
    data = epred_draws_brm_gender,
    alpha = .8,
    point_interval = "mean_qi",
    .width = c(0.5, 0.95),
  ) +
  scale_color_grey(
    start = 0.85, end = 0.65,
    labels = as_mapper(~ scales::percent(as.numeric(.x)))
  ) +
  # Add experiment-specific effect sizes and CIs as dots with error bars
  geom_linerange(aes(xmin = ci_lb, xmax = ci_ub), size = 0.35) +
  geom_point(aes(size = ni), shape = 22, fill = "white") + # Or (1 / vi)?
  # Add posterior distribution for the meta-analytic effect
  stat_halfeye(
    aes(x = intercept, y = -1),
    draws_brm_gender,
    point_interval = "mean_qi",
    .width = c(0.95)
  ) +
  annotate(
    "text",
    x = c(-9.9, 3.7, 4.4, 5.1),
    y = -0.5,
    label = c(
      "Three-level model",
      print_num(summ_brm_gender$intercept),
      print_num(summ_brm_gender$intercept.lower),
      print_num(summ_brm_gender$intercept.upper)
    ),
    hjust = c(0, 1, 1, 1),
    fontface = "bold"
  ) +
  # Add headers for each of the for columns
  annotate( # Just to make the grid lines disappear
    "rect",
    xmin = -Inf,
    xmax = Inf,
    ymin = nrow(dat_gender) + 0.5,
    ymax = Inf,
    fill = "white"
  ) +
  annotate(
    "text",
    x = c(-9.9, -7.1, 0, 3.7, 4.4, 5.1),
    y = nrow(dat_gender) + 1.5,
    label = c(
      "Article",
      "Experiment",
      "Effect size plot",
      "Effect size",
      "Lower",
      "Upper"
    ),
    hjust = c(0, 0, 0.5, 1, 1, 1),
    fontface = "bold"
  ) +
  # Styling
  coord_cartesian(
    ylim = c(-1.5, nrow(dat_gender) + 2), expand = FALSE, clip = "off"
  ) +
  scale_x_continuous(breaks = seq(-3, 3, 0.5)) +
  annotate("segment", x = -3.3, xend = 3.3, y = -1.5, yend = -1.5) +
  labs(
    x = expression("Hedges'" ~ italic("g")),
    size = "Sample size",
    color = "CrI level"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(family = "Helvetica", color = "black"),
    axis.text.y = element_blank(),
    axis.ticks.x = element_line(colour = "black"),
    axis.title.x = element_text(hjust = 0.67, margin = margin(b = -15)),
    axis.title.y = element_blank(),
    panel.grid = element_blank(),
    text = element_text(family = "Helvetica")
  )

# Save the plot
ggsave(here(figures_dir, "figs1_gender.pdf"), width = 12, height = 8)
```

(ref:figs1-caption) **Meta-analysis of gender differences.** A Bayesian three-level meta-analysis provided evidence for a small gender difference in mental rotation performance between male and female infants. White squares indicate the effect sizes (Hedges’ $g$) for gender difference in all individual experiments and black lines their 95% confidence intervals. Note that for experiments that observed a non-significant gender difference and did not specify the exact size of this effect, we assumed an effect size of $g = 0.00$. Gray bars indicate the 95% and 50% Bayesian credible interval (CrI) based on a Bayesian three-level random-effects model. Note that these intervals got shrunk towards the meta-analytic effect size because of partial pooling, that is, the three-level model regularizing the impact of experiments with small sample sizes and/or unrealistically large effect sizes. The last line shows the meta-analytic effect size from the three-level model (black dot) together with its 95% CrI (black line) and its posterior distribution (gray curve).

```{r, figs2, include=TRUE, fig.height=6, fig.width=12, fig.cap="(ref:figs2-caption)"}
# Extract convergence statistics from results
conv_stats <- with(summary(res_brm), tibble(
  parameter = c(
    "b_Intercept", "sd_article__Intercept", "sd_article:experiment__Intercept"
  ),
  name_expr = c(
    "Hedges ~ italic(g)", "italic(sigma)[article]", "italic(sigma)[experiment]"
  ),
  r_hat = print_num(c(fixed$Rhat, map_dbl(random, ~ .$Rhat)), digits = 4),
  bulk_ess = round(c(fixed$Bulk_ESS, map_dbl(random, ~ .$Bulk_ESS))),
  tail_ess = round(c(fixed$Tail_ESS, map_dbl(random, ~ .$Tail_ESS))),
  r_hat_expr = str_c("italic(R)[hat] == ", r_hat),
  bulk_ess_expr = str_c("italic(N)[eff(bulk)] == ", bulk_ess),
  tail_ess_expr = str_c("italic(N)[eff(tail)] == ", tail_ess),
  y_pos = c(0.7, 0.75, 0.8)
))

# Create trace plot
n_draws <- n_iter - n_warmup
bayesplot::mcmc_trace(
  res_brm,
  pars = conv_stats$parameter, facet_args = list(ncol = 1)
) +
  geom_text(
    aes(y = 0.45, label = name_expr, color = NA),
    conv_stats,
    y = 0.45, x = -800, color = "black", parse = TRUE, angle = 90
  ) +
  geom_text(
    aes(y = y_pos, label = r_hat_expr, color = NA),
    conv_stats,
    x = 13000, hjust = 1, color = "black", parse = TRUE,
  ) +
  geom_text(
    aes(y = y_pos, label = bulk_ess_expr, color = NA),
    conv_stats,
    x = 16000, hjust = 1, color = "black", parse = TRUE,
  ) +
  geom_text(
    aes(y = y_pos, label = tail_ess_expr, color = NA),
    conv_stats,
    x = 19000, hjust = 1, color = "black", parse = TRUE,
  ) +
  labs(x = "Sample number", y = NULL, color = "MCMC\nchain") +
  coord_cartesian(expand = FALSE, clip = "off") +
  scale_x_continuous(limits = c(0, n_draws), breaks = seq(0, n_draws, 2000)) +
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.2)) +
  scale_color_grey(start = 0.0, end = 0.9) +
  theme_classic() +
  theme(
    axis.line = element_line(colour = "black"),
    axis.text = element_text(family = "Helvetica", color = "black"),
    axis.ticks = element_line(color = "black"),
    plot.margin = margin(t = 10, l = 25),
    strip.background = element_blank(),
    strip.text = element_blank(),
    text = element_text(family = "Helvetica", color = "black")
  )

# Save the plot
ggsave(here(figures_dir, "figs2_convergence.pdf"), width = 12, height = 6)
```

(ref:figs2-caption) **Convergence checks for the Bayesian meta-analysis.** For each of the three parameters in the three-level meta-analytic model, gray traces show the exploration of the posterior distribution by four independent Markov Chain Monte Carlo (MCMC) chains. Overlap of the gray traces as well as random upward and downward fluctuations (rather than systematic drifts) indicate efficient exploration of the posterior distribution. Rhat = potential scale reduction factor, with values close to 1.0 indicating convergence of the chains, Neff(bulk) = bulk effective sample size, with larger values indicating better sampling efficiency in the bulk of the distribution (e.g., for estimating the posterior mean), Neff(tail) = tail effective sample size, with larger values indicating better sampling efficiency in the tails of the distribution (e.g., for estimating the 95% credible interval [CrI]). For details about these and other convergence criteria, we refer the reader to @vehtari2021.

```{r, figs3, include=TRUE, fig.height=4, fig.width=12, fig.cap="(ref:figs3-caption)"}
# Combine profile likelihood results into one data frame
prof_liks %>%
  head(-1) %>% # Remove the `comp` element
  map(~ tibble(sigma2 = .$sigma2, ll = .$ll)) %>%
  bind_rows(.id = "parameter") %>%
  # Create new labels for plotting
  mutate(parameter = factor(
    parameter,
    levels = c(1, 2),
    labels = c("italic(sigma)[article]^2", "italic(sigma)[experiment]^2")
  )) -> prof_liks_df

# Find the best-fitting parameter estimates
prof_liks_df %>%
  group_by(parameter) %>%
  filter(ll == max(ll)) -> prof_liks_max

# Create plot
prof_liks_df %>%
  ggplot(aes(x = sigma2, y = ll)) +
  facet_wrap(~parameter, scales = "free", labeller = label_parsed) +
  # Best fitting parameters
  geom_hline(
    aes(yintercept = ll),
    data = prof_liks_max, linetype = "dashed"
  ) +
  geom_vline(
    aes(xintercept = sigma2),
    data = prof_liks_max, linetype = "dashed"
  ) +
  # All tested parameters
  geom_point() +
  geom_line() +
  # Styling
  labs(x = "Parameter value", y = "Restricted log-likelihood") +
  theme_classic() +
  theme(
    axis.line = element_line(colour = "black"),
    axis.text = element_text(family = "Helvetica", color = "black"),
    axis.ticks = element_line(color = "black"),
    strip.background = element_blank(),
    text = element_text(family = "Helvetica", color = "black")
  )

# Save the plot
ggsave(here(figures_dir, "figs3_convergence_freq.pdf"), width = 12, height = 4)
```

(ref:figs3-caption) **Convergence checks for the frequentist meta-analysis.** Profile likelihood plots [@raue2009; @viechtbauer2010] indicate that restricted maximum likelihood estimation (REML) was able to identify the most likely parameter estimates for the two variance components in the three-level meta-analytic model, that is, for the between-article variance and for the between-experiment (within-article) variance.
