<!-- Re-define labels for tables and figures -->
\captionsetup[table]{name=Supplementary Table}
\captionsetup[figure]{name=Supplementary Fig.}

<!-- Restart numbering of figures, tables, equations, and pages -->
\renewcommand{\thefigure}{\arabic{figure}}
\renewcommand{\thetable}{\arabic{table}}
\renewcommand{\theequation}{\arabic{table}}
\setcounter{figure}{0}
\setcounter{table}{0}
\setcounter{equation}{0}
\setcounter{page}{1}

# Supplementary information

<!-- Supplementary methods -->

## Supplementary Methods 1 | Correlation between dependent samples

```{r, r_assumed}
# Compute empirical estimate of the correlation between dependent samples
dat %>%
  mutate(
    # Get effect size from paired samples t-test, one sample t-test, or ANOVA
    d_diff = case_when(
      !is.na(d) ~ d,
      !is.na(d_z_t) ~ d_z_t,
      !is.na(d_z_f) ~ d_z_f,
      !is.na(d_z_diff) ~ d_z_diff
    ),
    # Compute empirical correlation
    # Based on the SD of the difference and the SDs within the two conditions
    sd_diff = mean_diff / d_diff,
    ri = (sd_diff^2 - sd_novel^2 - sd_familiar^2) /
      (-2 * sd_novel * sd_familiar)
  ) %>%
  pull(ri) -> ri_empirical

# Subset articles that have an empirical estimate for the correlation
dat_ri_empirical <- filter(dat, !is.na(ri_empirical))

# Summarise the estimated correlations
(summ_ri_empirical <- print_num(summary(ri_empirical)))
```

Meta-analytic methods require an estimate of the sampling variance of each included experiment [@harrer2021]. For within-participant experimental designs (i.e., repeated measures on the same individuals in different conditions), this sampling variance needs to reflect that repeated measures from the same participant will be more similar to one another than measures from two randomly selected participants, thus not providing independent information. This is reflected by the correlation term $r$ in the formula of the standard error of the effect size ${SE}_\text{rotation}$ (see Methods) [@goulet-pelletier2018]. This correlation between repeated measures unfortunately tends to go unreported in research articles. In fact, none of the `r descs$n_articles` articles in the present meta-analysis provided a direct numerical estimate for the correlation between infants’ looking times in the novel and familiar rotation object conditions.

However, there were `r nrow(dat_ri_empirical)` experiments taken from seven different articles that included enough statistical information to reconstruct this correlation. This was done using the following procedure:

1. Extract an effect size $d_\text{diff}$ based on a paired $t$-test, a one-sample $t$-test of difference scores, or an ANOVA (see Rows (1) to (4) in Table 1). All three of these tests take the correlation between the repeated measures into account.

2. Extract the mean looking time difference $m_\text{diff}$ (in seconds) between the novel and familiar conditions.

3. Compute the standard deviation of the mean looking time difference: $${SD}_\text{diff}=\frac{m_\text{diff}}{d_\text{diff}}$$

4. Extract the standard deviations ${SD}_\text{novel}$ and ${SD}_\text{familiar}$ of looking times within each of the two conditions.

5. Compute the observed correlation between conditions based on rearranging an equation by @cohen1988: $$r=\frac{{SD}_\text{diff}^2-{SD}_\text{novel}^2-{SD}_\text{familiar}}{-2\cdot{SD}_\text{novel}^2\cdot{SD}_\text{familiar}^2}$$

Across these $`r nrow(dat_ri_empirical)`$ experiments, the average observed correlation was $r = `r summ_ri_empirical["Mean"]`$ (median $r = `r summ_ri_empirical["Median"]`$, range [`r summ_ri_empirical["Min."]`, `r summ_ri_empirical["Max."]`]). However, we decided to assume a correlation of $r  = .50$ when computing ${SE}_\text{rotation}$ for all `r descs$n_experiments` experiments. This was to ensure the comparability of our methods to meta-analyses of between-participant studies [@cohen1988; @lakens2013; @morris2002]. We ran a sensitivity analysis to test the robustness of our Bayesian meta-analytic model against this assumption (Supplementary Table 4).

<!-- Supplementary tables -->

```{r, tabs1, include=TRUE}
# Save within-analysis table of experiments
dat %>%
  mutate(
    age_mean = format_days_months(age_mean),
    age_sd = str_c(as.character(round(age_sd)), "d"),
  ) %>%
  transmute(
    Article = if_else(article == lag(article, default = ""), "", article),
    Experiment = group_long,
    `Sample size` = sample_size,
    `Females` = round(female_percent * sample_size),
    Age = str_c(age_mean, "±", age_sd, sep = " "),
    Task = task,
    `Stimulus type` = str_to_sentence(stimuli_presentation),
    `Stimulus dimensions` = stimuli_dimensions
  ) -> tabs1

# Display the table
apa_table(
  tabs1,
  caption = "Experiments included in the main analysis",
  landscape = TRUE, font_size = "scriptsize"
)

# Save the table
dir.create(tables_dir, showWarnings = FALSE)
write_csv(tabs1, file = here(tables_dir, "tabs1_experiments.csv"), na = "n/a")
```

\renewcommand{\arraystretch}{1.5}

```{r, frequentist}
# Three-level model
res_freq <- rma.mv(
  gi, vi,
  random = ~ 1 | article / experiment,
  data = dat,
  slab = experiment
)
print(res_freq)

# Check share of variance at each level of the model
round(res_freq$sigma2[1] / sum(res_freq$sigma2), 3) # Between-art. (ICC)
round(res_freq$sigma2[2] / sum(res_freq$sigma2), 3) # Within-art. (between-exp.)

# Get profile likelihoods for sigmas to check that REML has converged
prof_liks <- profile(res_freq, plot = FALSE)

# Meta-regression with gender, age, and task
res_reg_freq <- rma.mv(
  gi, vi,
  mods = ~ gender * age_c + task,
  random = ~ 1 | article / experiment,
  data = dat,
  slab = experiment
)
print(res_reg_freq)

# Meta-analysis of gender differences
res_gender_freq <- rma.mv(
  gi, vi,
  random = ~ 1 | article / experiment,
  data = dat_gender,
  slab = experiment
)
print(res_gender_freq)
```

```{r, tabs2, include=TRUE}
# Format all frequentist results together as a table
map2_dfr(
  c(
    "Meta-analysis of mental rotation",
    "Meta-regression of mental rotation",
    "Meta-analysis of gender differences"
  ),
  list(res_freq, res_reg_freq, res_gender_freq),
  function(name, res) {
    # Intercept / regression weights
    tibble(
      Model = c(name, rep(NA, length(res$b) - 1)),
      Parameter = rownames(res$b),
      Estimate = print_num(as.numeric(res$b)),
      `$SE$` = print_num(res$se),
      `$z$` = print_num(res$zval),
      `$p$` = print_num(res$pval, digits = 3),
      ci_lower = print_num(res$ci.lb),
      ci_upper = print_num(res$ci.ub)
    ) %>%
      # Re-format confidence interval
      mutate(
        `95\\% CI` = str_c("[", ci_lower, ", ", ci_upper, "]"),
        .keep = "unused"
      ) %>%
      # Add variances
      bind_rows(tibble(
        Parameter = res$s.name,
        Estimate = print_num(res$sigma2)
      ))
  }
) %>%
  # Rename parameters for readibility
  mutate(
    Parameter = c(
      "Hedges' $g$",
      "$\\sigma_{\\text{Article}}^2$",
      "$\\sigma_{\\text{Experiment}}^2$",
      "Intercept (Hedges' $g$)",
      "Female - mixed",
      "Male - female",
      "Age (per year)",
      "Habituation - VoE",
      "(Female - mixed) $\\times$ age",
      "(Male - female) $\\times$ age",
      "$\\sigma_{\\text{Article}}^2$",
      "$\\sigma_{\\text{Experiment}}^2$",
      "Hedges' $g$",
      "$\\sigma_{\\text{Article}}^2$",
      "$\\sigma_{\\text{Experiment}}^2$"
    )
  ) %>%
  # Replace NAs with blank cells
  mutate(across(.fns = ~ ifelse(is.na(.), "", .))) -> tab_freq

# Display the table
apa_table(
  tab_freq,
  align = "llccccc",
  caption = "Frequentist meta-analyses and meta-regression",
  font_size = "scriptsize",
  escape = FALSE
)

# Save the table
write_csv(tab_freq, file = here(tables_dir, "tabs2_frequentist.csv"))
```

```{r, jackknife, include=TRUE}
# Helper functions for printing results from Bayesian model as a table
print_res_table <- function(res,
                            label_1 = NULL,
                            label_2 = NULL,
                            label_col_1 = "label_1",
                            label_col_2 = "label_2") {
  spread_draws(res, `b_.*`, `sd_.*`, regex = TRUE, ndraws = NULL) %>%
    transmute(
      `Hedges' $g$` = b_Intercept,
      `$\\sigma_\\text{article}^2$` = sd_article__Intercept^2,
      `$\\sigma_\\text{experiment}^2$` = `sd_article:experiment__Intercept`^2,
      `${ICC}$` = `$\\sigma_\\text{article}^2$` /
        (`$\\sigma_\\text{article}^2$` + `$\\sigma_\\text{experiment}^2$`)
    ) %>%
    summarize(across(.fns = mean_qi)) %>%
    map_dfc(~ print_ci(.$ymin, .$ymax, mean = .$y)) -> tab
  if (!is.null(label_2)) {
    label_2_tab <- tibble(tmp = c(label_2, rep(NA, nrow(tab) - 1))) %>%
      rename(!!label_col_2 := tmp)
    tab <- cbind(label_2_tab, tab)
  }
  if (!is.null(label_1)) {
    label_1_tab <- tibble(tmp = c(label_1, rep(NA, nrow(tab) - 1))) %>%
      rename(!!label_col_1 := tmp)
    tab <- cbind(label_1_tab, tab)
  }
  return(tab)
}

# Re-run the jackknife analysis only if requested
jackknife_file <- here(tables_dir, "jackknife.csv")
if (run$jackknife_analysis) {

  # Re-fit the meta-analysis, leaving one experiment out at a time
  # Using parallelization with `furrr`
  n_cores <- availableCores()
  n_workers <- n_cores %/% n_chains
  plan(multisession, workers = n_workers)
  future_map_dfr(seq_len(nrow(dat[1:2, ])), function(jackknife_index) {
    dat_jackknife <- dat[-jackknife_index, ]
    res_jackknife <- update(res_brm, newdata = dat_jackknife, refresh = 0)
    print_res_table(
      res_jackknife,
      label_1 = dat$article[jackknife_index],
      label_2 = dat$group_long[jackknife_index],
      label_col_1 = "Article", label_col_2 = "Experiment"
    )
  }) -> jackknife_tab

  # Save the table
  write_csv(jackknife_tab, file = jackknife_file)
} else {

  # Otherwise we load the pre-computed results
  jackknife_tab <- read_csv(jackknife_file, col_types = "c")
}

# Display the table
apa_table(
  jackknife_tab,
  align = "llcccc",
  caption = "Jackknife (leave-one-out) analysis",
  font_size = "scriptsize",
  escape = FALSE
)
```

```{r, sensitivity_analysis}
# Re-run the sensitivity analyses only if requested
if (run$sensitivity_analysis) {

  # Re-run the meta-analysis for different values of r_assumed
  seq(-0.9, 0.9, by = 0.3) %>%
    map_dfr(function(ri_sens) {

      # Re-compute standard errors of the effect sizes
      mutate(
        dat,
        vi = (dfi / (dfi - 2)) * ((2 * (1 - ri_sens)) / ni) *
          (1 + gi^2 * (ni / (2 * (1 - ri_sens)))) - (gi^2 / ji^2),
        sei = sqrt(vi)
      ) -> dat_ri_sens

      # Re-run meta-analysis
      res <- update(res_brm, newdata = dat_ri_sens, refresh = 0)

      # Re-run meta-regression
      res_reg <- update(res_brm_reg, newdata = dat_ri_sens, refresh = 0)

      # Return both as a tibble together with the label
      return(
        tibble(
          manipulation_value = str_c("$r = ", print_num(ri_sens), "$"),
          res = list(res),
          res_reg = list(res_reg),
        )
      )
    }) %>%
    bind_cols(
      manipulation_name = c("Assumed correlation", rep("", nrow(.) - 1)), .
    ) -> res_ri_sens

  # Prior sensitivity analysis
  list(
    `$b\\sim\\mathcal{U}(-10,10)$` = c(
      set_prior("uniform(-10, 10)", class = "b", coef = "Intercept"),
      set_prior("normal(0, 0.5)", class = "b"),
      set_prior("cauchy(0, 0.3)", class = "sd")
    ),
    `$b\\sim\\mathcal{N}(0,0.2)$` = c(
      set_prior("normal(0, 0.2)", class = "b", coef = "Intercept"),
      set_prior("normal(0, 0.5)", class = "b"),
      set_prior("cauchy(0, 0.3)", class = "sd")
    ),
    `$\\sigma\\sim\\mathcal{U}(0,10)$` = c(
      set_prior("normal(0, 1)", class = "b", coef = "Intercept"),
      set_prior("normal(0, 0.5)", class = "b"),
      set_prior("uniform(0, 10)", class = "sd")
    ),
    `$\\sigma\\sim\\text{Student-}t(10,0,0.2)$` = c(
      set_prior("normal(0, 1)", class = "b", coef = "Intercept"),
      set_prior("normal(0, 0.5)", class = "b"),
      set_prior("student_t(10, 0, 0.2)", class = "sd")
    )
  ) %>%
    map2_dfr(names(.), function(prior_sens, prior_name) {

      # Re-run meta-analysis of mental rotation performance
      res <- update(res_brm, prior = prior_sens, refresh = 0)

      # Re-run meta-regression of mental rotation performance
      res_reg <- update(res_brm_reg, prior = prior_sens, refresh = 0)

      # Re-run meta-analysis of gender differences
      res_gender <- update(res_brm_gender, prior = prior_sens, refresh = 0)

      # Return both as a tibble together with the label
      return(
        tibble(
          manipulation_value = prior_name,
          res = list(res),
          res_reg = list(res_reg),
          res_gender = list(res_gender)
        )
      )
    }) %>%
    bind_cols(
      manipulation_name = c("Prior specification", rep("", nrow(.) - 1)), .
    ) -> res_prior_sens

  # Combine results from all sensitivity analyses
  res_sens <- bind_rows(res_ri_sens, res_prior_sens)

  # Backup for reuse
  saveRDS(res_sens, here(models_dir, "res_sens.rds"))
} else {
  # Otherwise we load the pre-fitted models
  res_sens <- readRDS(here(models_dir, "res_sens.rds"))
}
```

\renewcommand{\arraystretch}{1.0}

```{r, tabs5, include=TRUE}
# Combine results for the (main) meta-analysis of mental rotation performance
tab_sens <- res_sens %>%
  select(res, manipulation_name, manipulation_value) %>%
  pmap_dfr(function(res, manipulation_name, manipulation_value) {
    print_res_table(
      res,
      label_1 = manipulation_name, label_2 = manipulation_value,
      label_col_1 = "Manipulation", label_col_2 = " "
    )
  })

# Display the table
apa_table(
  tab_sens,
  caption = "Sensitivity analyses for the meta-analysis of mental rotation performance",
  font_size = "scriptsize", escape = FALSE
)

# Save the table
write_csv(tab_sens, file = here(tables_dir, "tabs5_sens.csv"))
```

```{r, tabs6, include=TRUE}
# Helper functions for printing results as a table
print_res_reg_table <- function(res_reg,
                                label_1,
                                label_2,
                                label_col_1,
                                label_col_2) {
  spread_draws(res_reg, `b_.*`, `sd_.*`, regex = TRUE, ndraws = NULL) %>%
    transmute(
      `Intercept` = b_Intercept,
      `Female - mixed` = b_gender2M1,
      `Male - female` = b_gender3M2,
      `Age (per year)` = b_age_c,
      `Habituation - VoE` = b_task2M1,
      `[Female - mixed] $\\times$ age` = `b_gender2M1:age_c`,
      `[Male - female] $\\times$ age` = `b_gender3M2:age_c`
    ) %>%
    summarize(across(.fns = mean_qi)) %>%
    map_dfc(~ print_ci(.$ymin, .$ymax, mean = .$y)) -> tab
  if (!is.null(label_2)) {
    label_2_tab <- tibble(tmp = c(label_2, rep(NA, nrow(tab) - 1))) %>%
      rename(!!label_col_2 := tmp)
    tab <- cbind(label_2_tab, tab)
  }
  if (!is.null(label_1)) {
    label_1_tab <- tibble(tmp = c(label_1, rep(NA, nrow(tab) - 1))) %>%
      rename(!!label_col_1 := tmp)
    tab <- cbind(label_1_tab, tab)
  }
  return(tab)
}

# Combine results for the meta-regression of mental rotation performance
tab_sens_reg <- res_sens %>%
  select(
    res_reg, manipulation_name, manipulation_value
  ) %>%
  pmap_dfr(function(res_reg, manipulation_name, manipulation_value) {
    print_res_reg_table(
      res_reg,
      label_1 = manipulation_name, label_2 = manipulation_value,
      label_col_1 = "Manipulation", label_col_2 = " "
    )
  })

# Display the table
apa_table(
  tab_sens_reg,
  caption = "Sensitivity analyses for the meta-regression of mental rotation performance",
  font_size = "scriptsize", landscape = TRUE, escape = FALSE
)

# Save the table
write_csv(tab_sens_reg, file = here(tables_dir, "tabs6_sens_reg.csv"))
```

```{r, tabs7, include=TRUE}
# Combine results for the meta-analysis of gender differences
tab_sens_gender <- res_sens %>%
  filter(!map_lgl(res_gender, is.null)) %>%
  select(res_gender, manipulation_name, manipulation_value) %>%
  pmap_dfr(function(res_gender, manipulation_name, manipulation_value) {
    print_res_table(
      res_gender,
      label_1 = manipulation_name, label_2 = manipulation_value,
      label_col_1 = "Manipulation", label_col_2 = " "
    )
  })

# Display the table
apa_table(
  tab_sens_gender,
  caption = "Sensitivity analyses for the meta-analysis of gender differences",
  font_size = "scriptsize", escape = FALSE
)

# Save the table
write_csv(tab_sens_gender, file = here(tables_dir, "tabs7_sens_gender.csv"))
```

<!-- Supplementary figures -->

```{r, figs1, include=TRUE, fig.height=10, fig.width=12, fig.cap="(ref:figs1-caption)"}
# Get posterior draws for the effect in each experiment
epred_draws_brm_gender <- epred_draws(res_brm_gender, dat_gender, ndraws = NULL) %>%
  mutate(experiment_f = factor(experiment))

# Create forest plot
dat_gender %>%
  # Make sure the plot will be ordered alphabetically by experiment IDs
  arrange(experiment) %>%
  mutate(
    experiment_f = fct_rev(fct_expand(factor(experiment), "model")),
    # Show article labels only for the first experiment per article
    article = if_else(article == lag(article, default = ""), "", article),
    # Compute frequentist confidence intervals
    ci_lb = gi - qnorm(0.05 / 2, lower.tail = FALSE) * sqrt(vi),
    ci_ub = gi + qnorm(0.05 / 2, lower.tail = FALSE) * sqrt(vi),
    ci_print = print_ci(gi, ci_lb, ci_ub)
  ) %>%
  # Prepare plotting canvas
  ggplot(aes(x = gi, y = experiment_f)) +
  geom_vline(xintercept = seq(-3, 3, 0.5), color = "grey90") +
  # Add article and group labels as text on the left
  geom_text(aes(x = -9.9, label = article), hjust = 0) +
  geom_text(aes(x = -7.1, label = group_long), hjust = 0) +
  # Add experiment-specific effect sizes and CIs as text on the right
  geom_text(aes(x = 3.7, label = print_num(gi)), hjust = 1) +
  geom_text(aes(x = 4.4, label = print_num(ci_lb)), hjust = 1) +
  geom_text(aes(x = 5.1, label = print_num(ci_ub)), hjust = 1) +
  # Add Bayesian highest posterior density intervals for each experiment
  stat_interval(
    aes(x = .epred),
    data = epred_draws_brm_gender,
    alpha = .8,
    point_interval = "mean_qi",
    .width = c(0.5, 0.95),
  ) +
  scale_color_grey(
    start = 0.85, end = 0.65,
    labels = as_mapper(~ scales::percent(as.numeric(.x)))
  ) +
  # Add experiment-specific effect sizes and CIs as dots with error bars
  geom_linerange(aes(xmin = ci_lb, xmax = ci_ub), size = 0.35) +
  geom_point(aes(size = ni), shape = 22, fill = "white") + # Or (1 / vi)?
  # Add posterior distribution for the meta-analytic effect
  stat_halfeye(
    aes(x = intercept, y = -1),
    draws_brm_gender,
    point_interval = "mean_qi",
    .width = c(0.95)
  ) +
  annotate(
    "text",
    x = c(-9.9, 3.7, 4.4, 5.1),
    y = -0.5,
    label = c(
      "Three-level model",
      print_num(summ_brm_gender$intercept),
      print_num(summ_brm_gender$intercept.lower),
      print_num(summ_brm_gender$intercept.upper)
    ),
    hjust = c(0, 1, 1, 1),
    fontface = "bold"
  ) +
  # Add headers for each of the for columns
  annotate( # Just to make the grid lines disappear
    "rect",
    xmin = -Inf,
    xmax = Inf,
    ymin = nrow(dat_gender) + 0.5,
    ymax = Inf,
    fill = "white"
  ) +
  annotate(
    "text",
    x = c(-9.9, -7.1, 0, 3.7, 4.4, 5.1),
    y = nrow(dat_gender) + 1.5,
    label = c(
      "Article",
      "Experiment",
      "Effect size plot",
      "Effect size",
      "Lower",
      "Upper"
    ),
    hjust = c(0, 0, 0.5, 1, 1, 1),
    fontface = "bold"
  ) +
  # Styling
  coord_cartesian(
    ylim = c(-1.5, nrow(dat_gender) + 2), expand = FALSE, clip = "off"
  ) +
  scale_x_continuous(breaks = seq(-3, 3, 0.5)) +
  annotate("segment", x = -3.3, xend = 3.3, y = -1.5, yend = -1.5) +
  labs(
    x = expression("Hedges'" ~ italic("g")),
    size = "Sample size",
    color = "CrI level"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(family = "Helvetica", color = "black"),
    axis.text.y = element_blank(),
    axis.ticks.x = element_line(colour = "black"),
    axis.title.x = element_text(hjust = 0.67, margin = margin(b = -15)),
    axis.title.y = element_blank(),
    panel.grid = element_blank(),
    text = element_text(family = "Helvetica")
  )

# Save the plot
ggsave(here(figures_dir, "figs1_gender.pdf"), width = 12, height = 8)
```

(ref:figs1-caption) **Meta-analysis of gender differences.** A Bayesian three-level meta-analysis provided evidence for a small gender difference in mental rotation performance between male and female infants. White squares indicate the effect sizes (Hedges’ $g$) for gender difference in all individual experiments and black lines their 95% confidence intervals. Note that for experiments that observed a non-significant gender difference and did not specify the exact size of this effect, we assumed an effect size of $g = 0.00$. Gray bars indicate the 95% and 50% Bayesian credible interval (CrI) based on a Bayesian three-level random-effects model. Note that these intervals got shrunk towards the meta-analytic effect size because of partial pooling, that is, the three-level model regularizing the impact of experiments with small sample sizes and/or unrealistically large effect sizes. The last line shows the meta-analytic effect size from the three-level model (black dot) together with its 95% CrI (black line) and its posterior distribution (gray curve).

```{r, figs2, include=TRUE, fig.height=6, fig.width=12, fig.cap="(ref:figs2-caption)"}
# Extract convergence statistics from results
conv_stats <- with(summary(res_brm), tibble(
  parameter = c(
    "b_Intercept", "sd_article__Intercept", "sd_article:experiment__Intercept"
  ),
  name_expr = c(
    "\"Hedges'\" ~ italic(g)",
    "italic(sigma)[article]",
    "italic(sigma)[experiment]"
  ),
  r_hat = print_num(c(fixed$Rhat, map_dbl(random, ~ .$Rhat)), digits = 4),
  bulk_ess = round(c(fixed$Bulk_ESS, map_dbl(random, ~ .$Bulk_ESS))),
  tail_ess = round(c(fixed$Tail_ESS, map_dbl(random, ~ .$Tail_ESS))),
  r_hat_expr = str_c("italic(R)[hat] == ", r_hat),
  bulk_ess_expr = str_c("italic(N)[eff(bulk)] == ", bulk_ess),
  tail_ess_expr = str_c("italic(N)[eff(tail)] == ", tail_ess),
  y_pos = c(0.7, 0.75, 0.8)
))

# Create trace plot
n_draws <- n_iter - n_warmup
bayesplot::mcmc_trace(
  res_brm,
  pars = conv_stats$parameter, facet_args = list(ncol = 1)
) +
  geom_text(
    aes(y = 0.45, label = name_expr, color = NA),
    conv_stats,
    y = 0.45, x = -0.042 * n_draws, color = "black", parse = TRUE, angle = 90
  ) +
  geom_text(
    aes(y = y_pos, label = r_hat_expr, color = NA),
    conv_stats,
    x = 0.684 * n_draws, hjust = 1, color = "black", parse = TRUE,
  ) +
  geom_text(
    aes(y = y_pos, label = bulk_ess_expr, color = NA),
    conv_stats,
    x = 0.842 * n_draws, hjust = 1, color = "black", parse = TRUE,
  ) +
  geom_text(
    aes(y = y_pos, label = tail_ess_expr, color = NA),
    conv_stats,
    x = n_draws, hjust = 1, color = "black", parse = TRUE,
  ) +
  labs(x = "Sample number", y = NULL, color = "MCMC\nchain") +
  coord_cartesian(expand = FALSE, clip = "off") +
  scale_x_continuous(limits = c(0, n_draws), breaks = seq(0, n_draws, 2000)) +
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.2)) +
  scale_color_grey(start = 0.0, end = 0.9) +
  theme_classic() +
  theme(
    axis.line = element_line(colour = "black"),
    axis.text = element_text(family = "Helvetica", color = "black"),
    axis.ticks = element_line(color = "black"),
    plot.margin = margin(t = 10, l = 25),
    strip.background = element_blank(),
    strip.text = element_blank(),
    text = element_text(family = "Helvetica", color = "black")
  )

# Save the plot
ggsave(here(figures_dir, "figs2_convergence.pdf"), width = 12, height = 6)
```

(ref:figs2-caption) **Convergence checks for the Bayesian meta-analysis.** For each of the three parameters in the three-level meta-analytic model, gray traces show the exploration of the posterior distribution by four independent Markov Chain Monte Carlo (MCMC) chains. Overlap of the gray traces as well as random upward and downward fluctuations (rather than systematic drifts) indicate efficient exploration of the posterior distribution. $R\text{hat}$ = potential scale reduction factor, with values close to 1.0 indicating convergence of the chains, $N_\text{eff(bulk)}$ = bulk effective sample size, with larger values indicating better sampling efficiency in the bulk of the distribution (e.g., for estimating the posterior mean), $N_\text{eff(tail)}$ = tail effective sample size, with larger values indicating better sampling efficiency in the tails of the distribution (e.g., for estimating the 95% credible interval [CrI]). For details about these and other convergence criteria, we refer the reader to @vehtari2021.

```{r, figs3, include=TRUE, fig.height=4, fig.width=12, fig.cap="(ref:figs3-caption)"}
# Combine profile likelihood results into one data frame
prof_liks %>%
  head(-1) %>% # Remove the `comp` element
  map(~ tibble(sigma2 = .$sigma2, ll = .$ll)) %>%
  bind_rows(.id = "parameter") %>%
  # Create new labels for plotting
  mutate(parameter = factor(
    parameter,
    levels = c(1, 2),
    labels = c("italic(sigma)[article]^2", "italic(sigma)[experiment]^2")
  )) -> prof_liks_df

# Find the best-fitting parameter estimates
prof_liks_df %>%
  group_by(parameter) %>%
  filter(ll == max(ll)) -> prof_liks_max

# Create plot
prof_liks_df %>%
  ggplot(aes(x = sigma2, y = ll)) +
  facet_wrap(~parameter, scales = "free", labeller = label_parsed) +
  # Best fitting parameters
  geom_hline(
    aes(yintercept = ll),
    data = prof_liks_max, linetype = "dashed"
  ) +
  geom_vline(
    aes(xintercept = sigma2),
    data = prof_liks_max, linetype = "dashed"
  ) +
  # All tested parameters
  geom_point() +
  geom_line() +
  # Styling
  labs(x = "Parameter value", y = "Restricted log-likelihood") +
  theme_classic() +
  theme(
    axis.line = element_line(colour = "black"),
    axis.text = element_text(family = "Helvetica", color = "black"),
    axis.ticks = element_line(color = "black"),
    strip.background = element_blank(),
    text = element_text(family = "Helvetica", color = "black")
  )

# Save the plot
ggsave(here(figures_dir, "figs3_convergence_freq.pdf"), width = 12, height = 4)
```

(ref:figs3-caption) **Convergence checks for the frequentist meta-analysis.** Profile likelihood plots [@raue2009; @viechtbauer2010] indicate that restricted maximum likelihood estimation (REML) was able to identify the most likely parameter estimates for the two variance components in the three-level meta-analytic model, that is, for the between-article variance and for the between-experiment (within-article) variance.


```{r, trim_and_fill_within}

# random-effects 2 level model
r_mod <- rma.uni(yi = dat$gi, vi = dat$vi)

# run trim and fill
res_tf <- trimfill(r_mod)
print(res_tf)
res_string <- "The publication-bias-corrected effect size of mental rotation was 0.16"

summ_brm <- list(intercept = res_tf$beta)
# Compute funnel
funnel_z_crit <- stats::qnorm(0.975)
funnel_max_se <- 0.5 # A bit larger than the largest observed `sei` in `dat`
funnel_tau2 <- 0 # We don't take heterogeneity into account, only the SE
funnel <- data.frame(
  x = c(
    summ_brm$intercept - funnel_z_crit * sqrt(funnel_max_se^2 + funnel_tau2),
    summ_brm$intercept - funnel_z_crit * sqrt(funnel_tau2),
    summ_brm$intercept + funnel_z_crit * sqrt(funnel_tau2),
    summ_brm$intercept + funnel_z_crit * sqrt(funnel_max_se^2 + funnel_tau2)
  ),
  y = c(funnel_max_se, 0, 0, funnel_max_se)
)

# # Create funnel plot
plotdata <- as.data.frame(list(yi = res_tf$yi, vi = sqrt(res_tf$vi)))
ggplot(plotdata, aes(x = yi, y = sqrt(vi))) +
  geom_vline(xintercept = seq(-2, 2, 0.5), color = "grey90") +
  # Meta-analytic effect size
  geom_vline(xintercept = summ_brm$intercept, color = "black") +
  # Experiment-specific effect sizes
  geom_point(shape = 0) +
  # Funnel
  geom_path(data = funnel, aes(x = x, y = y), linetype = "dashed") +
  # Styling
  scale_x_continuous(breaks = seq(-2, 2, 0.5)) +
  scale_y_reverse() +
  coord_cartesian(
    xlim = c(-2.5, 2.5),
    ylim = c(funnel_max_se, 0),
    expand = FALSE
  ) +
  labs(
    x = expression("Hedges'" ~ italic("g")),
    y = "Standard error",
  ) +
  theme_classic() +
  theme(
    axis.line = element_line(colour = "black"),
    axis.text = element_text(family = "Helvetica", color = "black"),
    axis.ticks = element_line(color = "black"),
    text = element_text(family = "Helvetica", color = "black")
  )

# Save the plot
ggsave(here(figures_dir, "funnel_taf.pdf"), width = 5.56, height = 3.5)
```

```{r,selection_models_within}
# random-effects 2 level model
r_mod <- rma.uni(yi = dat$gi, vi = dat$vi)


# EASY WEIGHT_FUNCTION MODEL
# Lauer 2019 "We first implemented the Vevea and Hedges (1995) weightfunction model 
# to estimate the population effect size after adjusting for selection bias."
# specifying p value cutpoints of 0.01, 0.05, and 0.10
sel_mod=selmodel(r_mod, type='stepfun',steps=c(0.01,.05, .3, 1),verbose=TRUE)
print(sel_mod)
print('The publication_bias-corrected estimate of the meta analytic effect is  0.21')


# 4 DIFFERENT STEP FUNCTION MODELS
# Lauer 2019 "We then conducted Vevea and Woods’ (2005) selection model analyses that 
# provide estimates of the mean weighted effect size assuming varying degrees of selection bias."
tab <- data.frame(
  steps = c(0.005, 0.01, 0.05, 0.10, 0.25, 0.35, 0.50, 0.65, 0.75, 0.90, 0.95, 0.99, 0.995, 1),
  delta.mod.1 = c(1, 0.99, 0.95, 0.80, 0.75, 0.65, 0.60, 0.55, 0.50, 0.50, 0.50, 0.50, 0.50, 0.50),
  delta.sev.1 = c(1, 0.99, 0.90, 0.75, 0.60, 0.50, 0.40, 0.35, 0.30, 0.25, 0.10, 0.10, 0.10, 0.10),
  delta.mod.2 = c(1, 0.99, 0.95, 0.90, 0.80, 0.75, 0.60, 0.60, 0.75, 0.80, 0.90, 0.95, 0.99, 1.00),
  delta.sev.2 = c(1, 0.99, 0.90, 0.75, 0.60, 0.50, 0.25, 0.25, 0.50, 0.60, 0.75, 0.90, 0.99, 1.00))

sel_moderateonetailed=selmodel(r_mod, type='stepfun',steps=tab$steps,delta=tab$delta.mod.1,verbose=TRUE)
sel_severeonetailed=selmodel(r_mod, type='stepfun',steps=tab$steps,delta=tab$delta.sev.1,verbose=TRUE)
sel_moderatetwotailed=selmodel(r_mod, type='stepfun',steps=tab$steps,delta=tab$delta.mod.2,verbose=TRUE)
sel_severetwotailed=selmodel(r_mod, type='stepfun',steps=tab$steps,delta=tab$delta.sev.2,verbose=TRUE)

print(sel_moderateonetailed)
print(sel_severeonetailed)
print(sel_moderatetwotailed)
print(sel_severetwotailed)

print('The publication_bias-corrected estimate of the meta analytic effect using a moderate one-tailed selection model is  0.1302')
print('The publication_bias-corrected estimate of the meta analytic effect using a severe one-tailed selection model is  -0.1421 ')
print('The publication_bias-corrected estimate of the meta analytic effect using a moderate two-tailed selection model is  0.2234')
print('The publication_bias-corrected estimate of the meta analytic effect using a severe two-tailed selection model is  0.1875')

interpretation="The analysis of four more selection models  showed that the effect is robustly larger than 0.1, excepting severe publication bias based on p-value"

```

```{r, tabs_trimfill_selectionmodels_within, include=TRUE}
# Format all frequentist results together as a table
map2_dfr(
  c(
    "Two-level random effects model",
    "Trim-and-fill",
    "Selection model: weight-function [0.01, 0.05, 0.3]",
    "Selection model: moderate one-tailed",
    "Selection model: severe one-tailed",
    "Selection model: moderate two-tailed",
  "Selection model: severe two-tailed"
  ),
    list(
      r_mod,
      res_tf,
      sel_mod,
      sel_moderateonetailed,
      sel_severeonetailed,
      sel_moderatetwotailed,
      sel_severetwotailed
      ),
  function(name, res) {
    print(name)
    # Intercept / regression weights
    tibble(
      Model = c(name, rep(NA, length(res$b) - 1)),
      Parameter = rownames(res$b),
      Estimate = print_num(as.numeric(res$b)),
      `$SE$` = print_num(res$se),
      `$z$` = print_num(res$zval),
      `$p$` = print_num(res$pval, digits = 3),
      ci_lower = print_num(res$ci.lb),
      ci_upper = print_num(res$ci.ub)
    ) %>%
      # Re-format confidence interval
      mutate(
        `95\\% CI` = str_c("[", ci_lower, ", ", ci_upper, "]"),
        .keep = "unused"
      ) %>%
      bind_rows()
  }
) %>%
  # Rename parameters for readibility
  mutate(
    Parameter = c(
      "Hedges' $g$"
    )
  ) %>%
  # Replace NAs with blank cells
  mutate(across(.fns = ~ ifelse(is.na(.), "", .))) -> tab_freq

# Display the table
apa_table(
  tab_freq,
  align = "llccccc",
  caption = "Sensitivity/robustness analyses frequentist",
  font_size = "scriptsize",
  escape = FALSE
)

# Save the table
write_csv(tab_freq, file = here(tables_dir, "robustness_freq.csv"))
```


```{r, trim_and_fill_gender}
dat=dat_gender

# random-effects 2 level model
r_mod <- rma.uni(yi = dat$gi, vi = dat$vi)

# run trim and fill
res_tf <- trimfill(r_mod)
print(res_tf)
# res_string <- "The publication-bias-corrected effect size of mental rotation was 0.16"

summ_brm <- list(intercept = res_tf$beta)
# Compute funnel
funnel_z_crit <- stats::qnorm(0.975)
funnel_max_se <- 0.5 # A bit larger than the largest observed `sei` in `dat`
funnel_tau2 <- 0 # We don't take heterogeneity into account, only the SE
funnel <- data.frame(
  x = c(
    summ_brm$intercept - funnel_z_crit * sqrt(funnel_max_se^2 + funnel_tau2),
    summ_brm$intercept - funnel_z_crit * sqrt(funnel_tau2),
    summ_brm$intercept + funnel_z_crit * sqrt(funnel_tau2),
    summ_brm$intercept + funnel_z_crit * sqrt(funnel_max_se^2 + funnel_tau2)
  ),
  y = c(funnel_max_se, 0, 0, funnel_max_se)
)

# # Create funnel plot
plotdata <- as.data.frame(list(yi = res_tf$yi, vi = sqrt(res_tf$vi)))
ggplot(plotdata, aes(x = yi, y = sqrt(vi))) +
  geom_vline(xintercept = seq(-2, 2, 0.5), color = "grey90") +
  # Meta-analytic effect size
  geom_vline(xintercept = summ_brm$intercept, color = "black") +
  # Experiment-specific effect sizes
  geom_point(shape = 0) +
  # Funnel
  geom_path(data = funnel, aes(x = x, y = y), linetype = "dashed") +
  # Styling
  scale_x_continuous(breaks = seq(-2, 2, 0.5)) +
  scale_y_reverse() +
  coord_cartesian(
    xlim = c(-2.5, 2.5),
    ylim = c(funnel_max_se, 0),
    expand = FALSE
  ) +
  labs(
    x = expression("Hedges'" ~ italic("g")),
    y = "Standard error",
  ) +
  theme_classic() +
  theme(
    axis.line = element_line(colour = "black"),
    axis.text = element_text(family = "Helvetica", color = "black"),
    axis.ticks = element_line(color = "black"),
    text = element_text(family = "Helvetica", color = "black")
  )

# Save the plot
ggsave(here(figures_dir, "funnel_taf.pdf"), width = 5.56, height = 3.5)
```

```{r,selection_models_gender}
# random-effects 2 level model
r_mod <- rma.uni(yi = dat$gi, vi = dat$vi)


# EASY WEIGHT_FUNCTION MODEL
# Lauer 2019 "We first implemented the Vevea and Hedges (1995) weightfunction model 
# to estimate the population effect size after adjusting for selection bias."
# specifying p value cutpoints of 0.01, 0.05, and 0.10
sel_mod=selmodel(r_mod, type='stepfun',steps=c(0.01,.05, .3, 1),verbose=TRUE)
print(sel_mod)
# print('The publication_bias-corrected estimate of the meta analytic effect is  0.21')


# 4 DIFFERENT STEP FUNCTION MODELS
# Lauer 2019 "We then conducted Vevea and Woods’ (2005) selection model analyses that 
# provide estimates of the mean weighted effect size assuming varying degrees of selection bias."
tab <- data.frame(
  steps = c(0.005, 0.01, 0.05, 0.10, 0.25, 0.35, 0.50, 0.65, 0.75, 0.90, 0.95, 0.99, 0.995, 1),
  delta.mod.1 = c(1, 0.99, 0.95, 0.80, 0.75, 0.65, 0.60, 0.55, 0.50, 0.50, 0.50, 0.50, 0.50, 0.50),
  delta.sev.1 = c(1, 0.99, 0.90, 0.75, 0.60, 0.50, 0.40, 0.35, 0.30, 0.25, 0.10, 0.10, 0.10, 0.10),
  delta.mod.2 = c(1, 0.99, 0.95, 0.90, 0.80, 0.75, 0.60, 0.60, 0.75, 0.80, 0.90, 0.95, 0.99, 1.00),
  delta.sev.2 = c(1, 0.99, 0.90, 0.75, 0.60, 0.50, 0.25, 0.25, 0.50, 0.60, 0.75, 0.90, 0.99, 1.00))

sel_moderateonetailed=selmodel(r_mod, type='stepfun',steps=tab$steps,delta=tab$delta.mod.1,verbose=TRUE)
sel_severeonetailed=selmodel(r_mod, type='stepfun',steps=tab$steps,delta=tab$delta.sev.1,verbose=TRUE)
sel_moderatetwotailed=selmodel(r_mod, type='stepfun',steps=tab$steps,delta=tab$delta.mod.2,verbose=TRUE)
sel_severetwotailed=selmodel(r_mod, type='stepfun',steps=tab$steps,delta=tab$delta.sev.2,verbose=TRUE)

print(sel_moderateonetailed)
print(sel_severeonetailed)
print(sel_moderatetwotailed)
print(sel_severetwotailed)

# print('The publication_bias-corrected estimate of the meta analytic effect using a moderate one-tailed selection model is  0.1302')
# print('The publication_bias-corrected estimate of the meta analytic effect using a severe one-tailed selection model is  -0.1421 ')
# print('The publication_bias-corrected estimate of the meta analytic effect using a moderate two-tailed selection model is  0.2234')
# print('The publication_bias-corrected estimate of the meta analytic effect using a severe two-tailed selection model is  0.1875')

# interpretation="The analysis of four more selection models  showed that the effect is robustly larger than 0.1, excepting severe publication bias based on p-value"

```

```{r, tabs_trimfill_selectionmodels_gender, include=TRUE}
# Format all frequentist results together as a table
map2_dfr(
  c(
    "Two-level random effects model",
    "Trim-and-fill",
    "Selection model: weight-function [0.01, 0.05, 0.3]",
    "Selection model: moderate one-tailed",
    "Selection model: severe one-tailed",
    "Selection model: moderate two-tailed",
  "Selection model: severe two-tailed"
  ),
    list(
      r_mod,
      res_tf,
      sel_mod,
      sel_moderateonetailed,
      sel_severeonetailed,
      sel_moderatetwotailed,
      sel_severetwotailed
      ),
  function(name, res) {
    print(name)
    # Intercept / regression weights
    tibble(
      Model = c(name, rep(NA, length(res$b) - 1)),
      Parameter = rownames(res$b),
      Estimate = print_num(as.numeric(res$b)),
      `$SE$` = print_num(res$se),
      `$z$` = print_num(res$zval),
      `$p$` = print_num(res$pval, digits = 3),
      ci_lower = print_num(res$ci.lb),
      ci_upper = print_num(res$ci.ub)
    ) %>%
      # Re-format confidence interval
      mutate(
        `95\\% CI` = str_c("[", ci_lower, ", ", ci_upper, "]"),
        .keep = "unused"
      ) %>%
      bind_rows()
  }
) %>%
  # Rename parameters for readibility
  mutate(
    Parameter = c(
      "Hedges' $g$"
    )
  ) %>%
  # Replace NAs with blank cells
  mutate(across(.fns = ~ ifelse(is.na(.), "", .))) -> tab_freq

# Display the table
apa_table(
  tab_freq,
  align = "llccccc",
  caption = "Sensitivity/robustness analyses frequentist",
  font_size = "scriptsize",
  escape = FALSE
)

# Save the table
write_csv(tab_freq, file = here(tables_dir, "robustness_freq_gender.csv"))
```